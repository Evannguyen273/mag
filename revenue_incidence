-- 1. Identify bestsellers and their delivery metrics
WITH bestsellers AS (
    SELECT 
        product_name,
        COUNT(orderid) as total_orders,
        SUM(daily_revenue) as total_revenue,
        AVG(CAST(is_short_pick AS FLOAT)) * 100 as short_pick_rate,
        AVG(CAST(is_zero_pick AS FLOAT)) * 100 as zero_pick_rate,
        AVG(CAST(is_on_time AS FLOAT)) * 100 as on_time_rate,
        AVG(CAST(is_delivery_failure AS FLOAT)) * 100 as delivery_failure_rate
    FROM orders
    GROUP BY product_name
    HAVING COUNT(orderid) >= 100  -- minimum order threshold
)
SELECT 
    *,
    ROW_NUMBER() OVER (ORDER BY total_revenue DESC) as revenue_rank
FROM bestsellers
WHERE total_orders >= 100  -- Additional filter for significant products
ORDER BY total_revenue DESC
LIMIT 20;

-- 2. Daily delivery performance for top products
WITH top_products AS (
    SELECT product_name
    FROM orders
    GROUP BY product_name
    ORDER BY SUM(daily_revenue) DESC
    LIMIT 20
)
SELECT 
    order_day,
    product_name,
    COUNT(orderid) as daily_orders,
    AVG(CAST(is_short_pick AS FLOAT)) * 100 as short_pick_rate,
    AVG(CAST(is_zero_pick AS FLOAT)) * 100 as zero_pick_rate,
    AVG(CAST(is_on_time AS FLOAT)) * 100 as on_time_rate,
    AVG(CAST(is_delivery_failure AS FLOAT)) * 100 as failure_rate
FROM orders
WHERE product_name IN (SELECT product_name FROM top_products)
GROUP BY order_day, product_name
ORDER BY order_day;

-- 3. Delivery performance by carrier for bestsellers
WITH top_products AS (
    SELECT product_name
    FROM orders
    GROUP BY product_name
    ORDER BY SUM(daily_revenue) DESC
    LIMIT 20
)
SELECT 
    carrier,
    COUNT(orderid) as total_deliveries,
    AVG(CAST(is_on_time AS FLOAT)) * 100 as on_time_rate,
    AVG(CAST(is_delivery_failure AS FLOAT)) * 100 as failure_rate,
    AVG(CAST(is_short_pick AS FLOAT)) * 100 as short_pick_rate
FROM orders
WHERE product_name IN (SELECT product_name FROM top_products)
GROUP BY carrier
HAVING COUNT(orderid) >= 50
ORDER BY total_deliveries DESC;

-- 4. Trend analysis for delivery issues
SELECT 
    DATE_TRUNC('week', order_day) as week,
    COUNT(orderid) as to
